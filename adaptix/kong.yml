_format_version: "3.0"
_transform: true

consumers:
  - id: 53a46fb7-0d86-4691-a3ab-6f963182211a
    username: product-client

services:
  - id: 2915b562-3d36-4b29-82ed-c49aaeb45c4b
    name: auth-service
    tags:
      - auth-service
    url: http://adaptix-auth-service:8000
    routes:
      # public endpoints (no JWT)
      - id: b3f1c9a2-9e84-4f2c-8e6a-1f2b3c4d5e6f
        name: auth-login-route
        paths:
          - /api/auth/login
          - /api/auth/login/
        strip_path: false
        protocols:
          - http
          - https

      - id: 5543c6e8-07b9-4a0b-96d5-1f92c3d5a415
        name: auth-register-route
        paths:
          - /api/auth/register
          - /api/auth/register/
        strip_path: false
        protocols:
          - http
          - https

      - id: a2d8e9c4-6b11-4f3b-9b8d-2a3c4e5f6b7c
        name: auth-password-reset-route
        paths:
          - /api/auth/password/reset
          - /api/auth/password/reset/
        strip_path: false
        protocols:
          - http
          - https

      - id: c1e7f6b8-5a22-4d88-9c7f-3b4a5c6d7e8f
        name: auth-verify-email-route
        paths:
          - /api/auth/verify-email
          - /api/auth/verify-email/
        strip_path: false
        protocols:
          - http
          - https

      - id: d4f2a1b9-8c33-4e99-8a6b-4c5d6e7f8a90
        name: auth-resend-verification-route
        paths:
          - /api/auth/resend-verification
          - /api/auth/resend-verification/
        strip_path: false
        protocols:
          - http
          - https

      - id: e5a3b2c0-9d44-4faa-9b5c-5d6e7f8a9b01
        name: auth-docs-route
        paths:
          - /api/auth/docs
          - /api/auth/docs/
        strip_path: false
        protocols:
          - http
          - https

      # fallback protected route for all other auth endpoints (requires JWT)
      - id: f6b4c3d2-0e55-4bbb-9c4d-6e7f8a9b0c12
        name: auth-protected-route
        paths:
          - /api/auth
          - /api/auth/
        strip_path: false
        protocols:
          - http
          - https
  - name: company-service
    url: http://company:8000
    routes:
      - name: company-all
        paths:
          - /api/company
        strip_path: false
        protocols:
          - http
          - https

      # docs routes (optional public)
      - name: company-docs-swagger
        paths:
          - /api/company/docs/swagger
          - /api/company/docs/swagger/
        strip_path: false
        protocols:
          - http
          - https

      - name: company-docs-redoc
        paths:
          - /api/company/docs/redoc
          - /api/company/docs/redoc/
        strip_path: false
        protocols:
          - http
          - https

      - name: company-schema
        paths:
          - /api/company/schema
          - /api/company/schema/
        strip_path: false
        protocols:
          - http
          - https

  - name: asset-service
    url: http://asset:8000
    routes:
      - name: asset-route
        paths:
          - /api/asset
        strip_path: false
        protocols:
          - http
          - https

  - name: customer-service
    url: http://customer:8000
    routes:
      - name: customer-profile-route
        paths:
          - /api/customer
        strip_path: false
        protocols:
          - http
          - https
      - name: customer-crm-route
        paths:
          - /api/crm
        strip_path: false
        protocols:
          - http
          - https

  - name: product-service
    url: http://product:8000
    routes:
      - name: product-route
        paths:
          - /api/product
        strip_path: false
        protocols:
          - http
          - https

  - name: pos-service
    url: http://pos:8000
    routes:
      - name: pos-route
        paths:
          - /api/pos
        strip_path: false
        protocols:
          - http
          - https

  - name: inventory-service
    url: http://inventory:8000
    routes:
      - name: inventory-route
        paths:
          - /api/inventory
        strip_path: false
        protocols:
          - http
          - https

  - name: purchase-service
    url: http://purchase:8000
    routes:
      - name: purchase-route
        paths:
          - /api/purchase
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              claims_to_verify: ["exp"]
              key_claim_name: iss

  - name: hrms-service
    url: http://hrms-service:8000
    routes:
      - name: hrms-route
        paths:
          - /api/hrms
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              claims_to_verify: ["exp"]
              key_claim_name: iss

  - name: accounting-service
    url: http://accounting:8000
    routes:
      - name: accounting-route
        paths:
          - /api/accounting
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              claims_to_verify: ["exp"]
              key_claim_name: iss

  - name: notification-service
    url: http://notification:8000
    routes:
      - name: notification-route
        paths:
          - /api/notification
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              claims_to_verify: ["exp"]
              key_claim_name: iss

  - name: reporting-service
    url: http://reporting:8000
    routes:
      - name: reporting-route
        paths:
          - /api/reporting
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              claims_to_verify: ["exp"]
              key_claim_name: iss

  - name: promotion-service
    url: http://promotion:8000
    routes:
      - name: promotion-route
        paths:
          - /api/promotion
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              claims_to_verify: ["exp"]
              key_claim_name: iss

  - name: payment-service
    url: http://payment:8000
    routes:
      - name: payment-route
        paths:
          - /api/payment
        strip_path: false
        protocols:
          - https
        plugins:
          - name: jwt
            config:
              claims_to_verify: ["exp"]
              key_claim_name: iss

  - name: intelligence-service
    url: http://ai-service:8000
    routes:
      - name: intelligence-route
        paths:
          - /api/intelligence
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              claims_to_verify: ["exp"]
              key_claim_name: iss

  - name: quality-service
    url: http://quality-service:8000
    routes:
      - name: quality-route
        paths:
          - /api/quality
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              claims_to_verify: ["exp"]
              key_claim_name: iss

  - name: logistics-service
    url: http://logistics-service:8000
    routes:
      - name: logistics-route
        paths:
          - /api/logistics
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              claims_to_verify: ["exp"]
              key_claim_name: iss

  - name: intelligence-service
    url: http://intelligence-service:8000
    routes:
      - name: intelligence-route
        paths:
          - /api/intelligence
        strip_path: false
        protocols:
          - http
          - https
        plugins:
          - name: jwt
            config:
              claims_to_verify: ["exp"]
              key_claim_name: iss

jwt_secrets:
  - id: 4ba55d53-8acb-403e-a089-edf75b355cc3
    consumer:
      id: 53a46fb7-0d86-4691-a3ab-6f963182211a
    key: auth-service
    algorithm: RS256
    rsa_public_key: |
      -----BEGIN PUBLIC KEY-----
      MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAueWCVPzwfjT/q4rt24OG
      N+3LQQexELzgWeXP6CKn9LmN4eaiHhwb91/aEg9c4x8jSGvyCVCXJc8bHje6c2HB
      0gW2/lSSw5oUbWEFBm7WtIPDxKpaOalGVk4DaDLswJmxhk1N16uEA3ussXyHLXdl
      EHWlewZzh88/Y7faKTvmO9pPuwJWm3b2gw2TfMIV072Ypklfre0LeoabN3eEoN09
      x1+riOtDBoJaOi1xDFRzweSXBwuxVoZqa8Xjx2DVAhm4J37Gq/Jadxlv986bs/R/
      NXS2chUIboUkprynxMgBuOLPFX+KUaDediZxk8QIBuOAXJgmvXtiMD5Eos5Af33W
      LwIDAQAB
      -----END PUBLIC KEY-----

plugins:
  # CORS applied to the auth service (keeps browser swagger working)
  - name: cors
    service:
      id: 2915b562-3d36-4b29-82ed-c49aaeb45c4b
    config:
      origins: ["*"]
      methods: ["GET", "POST", "OPTIONS", "PUT", "PATCH", "DELETE"]
      headers: ["Authorization", "Content-Type", "Accept"]
      credentials: true

  # ============================================
  # üîê JWT AUTHENTICATION (Applied to all protected APIs)
  # ============================================
  - name: jwt
    route:
      id: f6b4c3d2-0e55-4bbb-9c4d-6e7f8a9b0c12 # auth-protected
    config:
      claims_to_verify: ["exp"]
      key_claim_name: iss

  # ============================================
  # üîí SECURITY PLUGINS
  # ============================================

  # Global Rate Limiting - Prevents DDoS and brute force
  - name: rate-limiting
    config:
      minute: 5000 # 5000 requests per minute per IP
      hour: 10000 # 10000 requests per hour per IP
      policy: local # Use 'redis' in production for distributed limiting
      fault_tolerant: true # Continue if rate limiting fails
      hide_client_headers: false

  # Stricter rate limiting for login endpoint
  - name: rate-limiting
    route:
      id: b3f1c9a2-9e84-4f2c-8e6a-1f2b3c4d5e6f
    config:
      minute: 1000 # Only 1000 login attempts per minute
      hour: 5000 # Only 5000 per hour
      policy: local

  # Request Size Limiting - Prevents large payload attacks
  - name: request-size-limiting
    config:
      allowed_payload_size: 10 # 10 MB max request size

  # Response Rate Limiting (Bot Protection)
  - name: response-ratelimiting
    config:
      limits:
        limit_name:
          minute: 200

  # Bot Detection - Block common bad bots
  - name: bot-detection
    config:
      deny:
        - "wget"
        - "python-requests"
      allow:
        - "PostmanRuntime"
        - "insomnia"
