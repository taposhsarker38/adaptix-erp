# ================================================
# Automated Daily Database Backup
# ================================================
# Runs daily at 2 AM
# Backs up to cloud storage (S3/GCS/Azure Blob)

name: üóÑÔ∏è Database Backup

on:
  schedule:
    - cron: "0 2 * * *" # Daily at 2 AM UTC
  workflow_dispatch: # Manual trigger

env:
  BACKUP_RETENTION_DAYS: 30

jobs:
  backup:
    name: Backup Database
    runs-on: ubuntu-latest

    steps:
      - name: Create Backup via SSH
        uses: appleboy/ssh-action@v1.2.4
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            #!/bin/bash
            set -e

            BACKUP_DIR="/opt/adaptix/backups"
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            BACKUP_FILE="adaptix_backup_${TIMESTAMP}.sql.gz"

            # Create backup directory
            mkdir -p $BACKUP_DIR

            # Create backup
            echo "üì¶ Creating database backup..."
            docker-compose -f /opt/adaptix/docker-compose.yml exec -T postgres \
                pg_dump -U adaptix adaptix_saas | gzip > $BACKUP_DIR/$BACKUP_FILE

            echo "‚úÖ Backup created: $BACKUP_FILE"
            echo "üìä Size: $(du -h $BACKUP_DIR/$BACKUP_FILE | cut -f1)"

            # Upload to S3 (if configured)
            if [ -n "$AWS_ACCESS_KEY_ID" ]; then
                aws s3 cp $BACKUP_DIR/$BACKUP_FILE s3://${{ secrets.S3_BUCKET }}/backups/$BACKUP_FILE
                echo "‚òÅÔ∏è Uploaded to S3"
            fi

            # Clean old backups (keep last 30 days)
            find $BACKUP_DIR -name "adaptix_backup_*.sql.gz" -mtime +30 -delete
            echo "üßπ Cleaned old backups"

      - name: Verify Backup
        uses: appleboy/ssh-action@v1.2.4
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            # Check backup file exists and is not empty
            LATEST=$(ls -t /opt/adaptix/backups/*.sql.gz | head -1)
            SIZE=$(stat -f%z "$LATEST" 2>/dev/null || stat -c%s "$LATEST")

            if [ "$SIZE" -lt 1000 ]; then
                echo "‚ùå Backup file too small, might be corrupted!"
                exit 1
            fi

            echo "‚úÖ Backup verified: $LATEST ($SIZE bytes)"

      - name: Notify on Failure
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          text: "‚ùå Database backup failed!"
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
